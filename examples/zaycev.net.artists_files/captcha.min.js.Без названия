(function(){function g(a){this.deferred=a}function c(){e=$("#captcha-dialog");e.length||(e=$(ZINA.el("div#captcha-dialog.modal__window")).appendTo("body"),e.dialog({modal:!0,autoOpen:!1,width:485,resizable:!1,title:ZINA.defaults("ZINA.Captcha","title")}));return e}function k(a){var b=$.ajax({url:"/captcha/validate",dataType:"json",type:"get"});b.done(function(b){c().html(ZINA.Captcha.render(b,!1));l(a)});b.fail(function(){h(a)});b.always(function(){a.spinner&&(a.spinner.stop(),a.spinner=null)});return b}
function m(a,b,f){b=$.ajax({url:"/captcha/validate",dataType:"json",type:"post",data:{id:b,value:f}});b.done(function(b){if(b.success)a.deferred.resolve(),c().dialog("close");else{var f=c();$("div.captcha-dialog",f).html($(ZINA.Captcha.render(b,!0)).children())}});b.fail(function(){h(a)});return b}function l(a){c().find("div.captcha-dialog").each(function(){var b=$(this);b.on("click","button.captcha-dialog__submit",function(){var b=$(this);if(!b.is(":disabled")){b.attr("disabled","disabled");var d=
c().find("input.captcha-dialog__value");m(a,d.data("id"),d.val()).always(function(){b.removeAttr("disabled")})}});b.on("keydown","input.captcha-dialog__value",function(a){13==a.which&&b.find("button.captcha-dialog__submit").trigger("click")});b.on("click","div.captcha-dialog__reload",function(){var a=b.find("img.captcha-dialog__image"),d=a.clone(),c=a.attr("src"),c=c.split("?")[0]+"?_="+ +new Date;d.attr("src",c);a.replaceWith(d)})})}function h(a){c().html("\u041e\u0448\u0438\u0431\u043a\u0430");
a.deferred.reject()}var e;g.prototype.openDialog=function(){this.spinner=(new Spinner).spin();var a=c().dialog("open").html(this.spinner.el);k(this);return a};ZINA.namespace("ZINA.Captcha",{show:function(){var a=$.Deferred();(new g(a)).openDialog().on("dialogclose",function(){a.reject()});return a.promise()},process:function(a){var b=$.Deferred();(function d(){var c=a();c.done(function(a){a.captcha?ZINA.Captcha.show().done(function(){setTimeout(d,0)}).fail(b.reject):b.resolve(a)});c.fail(b.reject)})();
return b.promise()},render:function(a,b){var c=ZINA.el("div.captcha-dialog",[ZINA.el("div.captcha-dialog__intro",[ZINA.defaults("ZINA.Captcha","intro")]),ZINA.el("div.captcha-dialog__row",[ZINA.el("div.captcha-dialog__label",[ZINA.defaults("ZINA.Captcha","image")]),ZINA.el("img.captcha-dialog__image",{src:a.captchaUrl,width:170,height:70}),ZINA.el("div.captcha-dialog__reload")]),ZINA.el("div.captcha-dialog__row",[ZINA.el("div.captcha-dialog__label",[ZINA.defaults("ZINA.Captcha","text")]),ZINA.el("input.captcha-dialog__value",
{type:"text","data-id":a.captchaId}),function(){var a;b&&(a=ZINA.el("div.captcha-dialog__error",[ZINA.defaults("ZINA.Captcha","error")]));return a}()]),ZINA.el("div.ui-dialog-buttonpane.ui-dialog-buttonset.ui-helper-clearfix",[ZINA.el("button.captcha-dialog__submit.ui-button.ui-widget.ui-state-default.ui-corner-all.ui-button-text-only",[ZINA.el("span.ui-button-text",[ZINA.defaults("ZINA.Captcha","validate")])])])]);(function(a){$.isFunction(a.center)&&a.center($(c))})(ZINA.namespace("ZINA.DialogHelper"));
return c}})})();